
%if &isWKT = 1 %Then ;  

Proc COUCHEMSH ;
  Ouvre fichier = "ACOMMUNES.CodeBE_LL" IsFondCarte ;
   SetID Var = 'CodeBE' ;
  ExportXY Fichier = "AEXPORTBE.CodeBEWKT" WKT ;
  NoRedraw ;
Finproc ;

Tab TEMP.Test ;
  Ouvre AEXPORTBE.CodeBEWKT;
  lon =  Len(WKT);
Fintab ;
Proc STAT ;
   Table TEMP.Test ;
   TabOut TEMP.Test ;
   Var lon ;
   Fonctions Max ;
Finproc ;
Tab TEMP.Test ;
  Ouvre TEMP.Test;
  Macvar longueur, lon ;
Fintab ;
%out Longueur max du WKT : &longueur ;
%let longueur =  %f(&longueur+120) ;

Tab AEXPORTBE.ExportCodeBEWKT ;
  Ouvre AEXPORTBE.CodeBEWKT ;
  Declare SQL =  varchar(&longueur) ;
  SQL = 'Insert Into GEO_CodeBE_WKT(CodeBE, Polygon) values (\''+ID+'\', ST_PolygonFromText(\''+WKT+'\'));' ; 
  Keep SQL ;
Fintab ;

Proc EXPORT ;
  Table AEXPORTBE.ExportCodeBEWKT ;
  Fichier Extension = 'sql' Librairie = 'AEXPORTBE' Nom = "Export_GEO_CODEBE_COORDS_WKT" Separateur = 'COMMA' NoHeader ; 
Finproc ;

%endif ;
%if &isData = 1 %Then ; 	

Tab AEXPORTBE.ExportCodeBEData  ;
  Ouvre ACOMMUNES.CodeBE_LL ;
  Declare SQL =  varchar(1000) ;
  Declare PIA = varchar(20);

  PIA = Replace(NB_PIA,',','.') ;
  If (PIA =  '') Then;
    PIA =  'NULL' ;
  EndIf ;

  SQL = 'Insert Into GEO_CodeBE_DATA(CodeBE, NB_PIA) values(\''+CodeBE+'\', '+PIA+');' ; 
  
  Keep SQL ;
Fintab ;

Proc EXPORT ;
  Table AEXPORTBE.ExportCodeBEData ;
  Fichier Extension = 'sql' Librairie = 'AEXPORTBE' Nom = "Export_GEO_CODEBE_DATA" Separateur = 'COMMA' NoHeader ; 
Finproc ;

%endif ;